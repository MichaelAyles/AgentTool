input {
  beats {
    port => 5044
  }
  
  tcp {
    port => 5000
    codec => json_lines
  }
  
  http {
    port => 8080
    codec => json
  }
}

filter {
  if [fields][service] == "vibe-code-backend" {
    mutate {
      add_tag => ["backend"]
    }
    
    # Parse structured logs
    if [message] =~ /^\{.*\}$/ {
      json {
        source => "message"
      }
    }
    
    # Extract log level
    if [level] {
      mutate {
        add_field => { "log_level" => "%{level}" }
      }
    }
    
    # Parse timestamps
    if [timestamp] {
      date {
        match => [ "timestamp", "ISO8601" ]
      }
    }
  }
  
  if [fields][service] == "vibe-code-frontend" {
    mutate {
      add_tag => ["frontend"]
    }
  }
  
  # Add common fields
  mutate {
    add_field => {
      "environment" => "${NODE_ENV:development}"
      "application" => "vibe-code"
    }
  }
  
  # Parse user agent for frontend logs
  if "frontend" in [tags] and [user_agent] {
    useragent {
      source => "user_agent"
    }
  }
  
  # Parse validation logs
  if [validation_id] {
    mutate {
      add_tag => ["validation"]
    }
  }
  
  # Parse security logs
  if [security_event] {
    mutate {
      add_tag => ["security"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "vibe-code-%{+YYYY.MM.dd}"
  }
  
  # Debug output for development
  if "${NODE_ENV:development}" == "development" {
    stdout {
      codec => rubydebug
    }
  }
}