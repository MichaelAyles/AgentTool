name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  # Update dependencies
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install current dependencies
        run: bun install --frozen-lockfile

      - name: Update dependencies
        run: |
          # Update all dependencies
          bun update

          # Update workspace dependencies
          cd packages/backend && bun update
          cd ../frontend && bun update
          cd ../adapter-sdk && bun update
          cd ../shared && bun update

          # Update adapter dependencies
          cd ../../adapters/claude-code && bun update
          cd ../custom-script && bun update

      - name: Check for security vulnerabilities
        run: bun audit
        continue-on-error: true

      - name: Run tests with updated dependencies
        run: |
          bun run build
          bun run test
        continue-on-error: true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'Automated Dependency Updates'
          body: |
            ## Automated Dependency Updates

            This PR contains automated dependency updates for the Vibe Code project.

            ### Changes
            - Updated all npm/bun dependencies to their latest versions
            - Ran security audit to check for vulnerabilities
            - Verified tests still pass with updated dependencies

            ### Testing
            - [ ] All tests pass
            - [ ] Security audit clean
            - [ ] Manual testing of critical functionality

            Please review the changes and test thoroughly before merging.
          branch: dependency-updates
          delete-branch: true

  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run security audit
        run: |
          echo "Running security audit..."
          bun audit --json > audit-results.json || true

      - name: Process audit results
        run: |
          if [ -f audit-results.json ]; then
            # Count vulnerabilities by severity
            HIGH=$(cat audit-results.json | jq '.advisories | map(select(.severity == "high")) | length')
            MODERATE=$(cat audit-results.json | jq '.advisories | map(select(.severity == "moderate")) | length')
            LOW=$(cat audit-results.json | jq '.advisories | map(select(.severity == "low")) | length')
            
            echo "Security Audit Results:"
            echo "High: $HIGH"
            echo "Moderate: $MODERATE" 
            echo "Low: $LOW"
            
            if [ "$HIGH" -gt 0 ]; then
              echo "âŒ High severity vulnerabilities found!"
              exit 1
            fi
          fi

      - name: Create security issue
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Security Vulnerabilities Detected',
              body: `
              ## Security Alert
              
              Automated security audit has detected vulnerabilities in project dependencies.
              
              ### Action Required
              - Review the security audit results
              - Update vulnerable dependencies
              - Test thoroughly after updates
              
              **Workflow Run:** ${context.runId}
              **Detected:** ${new Date().toISOString()}
              `,
              labels: ['security', 'high-priority', 'dependencies']
            });

  # License compliance check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install license checker
        run: npm install -g license-checker

      - name: Check licenses
        run: |
          echo "Checking license compliance..."
          license-checker --json > licenses.json

          # Check for prohibited licenses
          PROHIBITED_LICENSES=("GPL-2.0" "GPL-3.0" "AGPL-1.0" "AGPL-3.0")

          for license in "${PROHIBITED_LICENSES[@]}"; do
            if grep -q "$license" licenses.json; then
              echo "âŒ Prohibited license found: $license"
              exit 1
            fi
          done

          echo "âœ… License compliance check passed"

      - name: Generate license report
        run: |
          license-checker --csv > license-report.csv

      - name: Upload license report
        uses: actions/upload-artifact@v3
        with:
          name: license-report
          path: license-report.csv
          retention-days: 30
